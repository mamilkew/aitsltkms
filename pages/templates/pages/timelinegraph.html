{% extends 'pages/layout.html' %}
{% load staticfiles %}
{% block header %}
    <link href="https://unpkg.com/event-drops/dist/style.css" rel="stylesheet"/>

{% endblock %}
{% block container %}
    <div class="row">
        <div id="eventdrops-project" style="width: 90%;"></div>
        <div id="eventdrops-demo" style="width: 90%;"></div>
        <p class="infos">
            <span id="numberCommits"></span> commits <span class="light">found between</span> <br/>
            <span id="zoomStart"></span> <span class="light">and</span> <span id="zoomEnd"></span>
        </p>
    </div>

{% endblock %}
{% block javascript %}
    <script src="https://unpkg.com/d3"></script>
    <script src="https://unpkg.com/event-drops"></script>

    <script>
        var options = {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'};
        const tooltip = d3
            .select('body')
            .append('div')
            .classed('tooltip', true)
            .style('opacity', 0)
            .style('pointer-events', 'auto');

        const chart = eventDrops({
            {#locale: usLocale,#}
            d3,
            {#zoom: {#}
            {#    onZoomEnd: () => updateCommitsInformation(chart),#}
            {#\},#}

            drop: { //drops ----- Default: row => row.data
                date: d => new Date(d.date), //Default: d => new Date(d)
                onMouseOver: commit => {
                    tooltip
                        .transition()
                        .duration(200)
                        .style('opacity', 1)
                        .style('pointer-events', 'auto');

                    tooltip
                        .html(
                            `
                    <div class="commit">
                    <div class="content">
                        <h4 class="message">${commit.message}</h4>
                        <p>
                            <a href="https://www.github.com/${commit.author.name}" class="author">${commit.author.name}</a>
                            on <span class="date">${new Intl.DateTimeFormat('en-US', options).format(new Date(commit.date))}</span> -
                            <a class="sha" href="${commit.sha}">${commit.sha.substr(0, 10)}</a>
                        </p>
                    </div>
                `
                        )
                        .style('left', `${d3.event.pageX - 30}px`)
                        .style('top', `${d3.event.pageY + 20}px`);
                },
                onMouseOut: () => {
                    tooltip
                        .transition()
                        .duration(1000)
                        .style('opacity', 0)
                        .style('pointer-events', 'none');
                },
            },
        });

        const repositories = [{
            "name": "admin-on-rest",
            "commits": [{
                "sha": "7ccf18b86328d5eb527d5cd803bca97b03640c6d",
                "message": "Merge-pull-request-1409-from-zifnab87-master",
                "author": {"name": "Gildas Garcia", "email": "gildas.garcia@gmail.com"},
                "date": "2018-01-23T15:03:41"
            }, {
                "sha": "7659f9a6006f4742f47f4daf023b65f14162ef6a",
                "message": "change-extraction-of-status-for-AUTH_ERROR",
                "author": {"name": "Michail Michailidis", "email": "zifnab87@users.noreply.github.com"},
                "date": "Tue, 23 Jan 2018 15:54:25 +0200"
            }]
        }, {
            "name": "EventDrops",
            "commits": [{
                "sha": "0280d01ea7b5829215d25ec1644c556efd6d29ed",
                "message": "Merge-pull-request-173-from-marmelab-jpetitcolas-patch-1",
                "author": {"name": "Francois Zaninotto", "email": "fzaninotto@gmail.com"},
                "date": "Thu, 21 Sep 2017 10:10:29 +0200"
            }]
        }, {
            "name": "sedy",
            "commits": [{
                "sha": "d4855b18f312bfd0ef6c1c471fda09773e955d4f",
                "message": "Merge-pull-request-89-from-marmelab-update-node-modules",
                "author": {"name": "Gildas Garcia", "email": "gildas.garcia@gmail.com"},
                "date": "Mon, 8 Jan 2018 11:21:55 +0100"
            }, {
                "sha": "deb575de94ad22f916d332b91a356960a715192f",
                "message": "Sedy-config-dependency",
                "author": {"name": "Kmaschta", "email": "kevin@marmelab.com"},
                "date": "Fri, 5 Jan 2018 18:24:01 +0100"
            }, {
                "sha": "4765bec07755fc8e0a99fa0f1a1520a8a7266d00",
                "message": "Sedy-Test-dependencies",
                "author": {"name": "Kmaschta", "email": "kevin@marmelab.com"},
                "date": "Fri, 5 Jan 2018 18:22:58 +0100"
            }]
        }, {
            "name": "comfy",
            "commits": [{
                "sha": "a88a85ddd12307e295635339dabd5bcf79b184fa",
                "message": "Merge-pull-request-114-from-arturparkhisenko-api-add-babel-env",
                "author": {"name": "Kmaschta", "email": "Kmaschta@users.noreply.github.com"},
                "date": "Thu, 16 Nov 2017 17:53:43 +0100"
            }, {
                "sha": "121c3b04071956b33a8225c4c9bfe715092d9ab2",
                "message": "upd-dependencies-prefix-env-eof",
                "author": {"name": "arturparkhisenko", "email": "ikeagold@gmail.com"},
                "date": "Mon, 13 Nov 2017 20:27:56 +0200"
            }, {
                "sha": "1985a7a078f36bd695bc6af2a8ea7e96192557d7",
                "message": "Merge-pull-request-115-from-marmelab-remove-admin",
                "author": {"name": "Jonathan Petitcolas", "email": "petitcolas.jonathan@gmail.com"},
                "date": "Mon, 13 Nov 2017 17:37:58 +0100"
            }]
        }];


        const repositoriesData = repositories.map(repository => ({
            name: repository.name,
            data: repository.commits,
        }));

        console.log(repositories);
        console.log(repositoriesData);
        d3.select('#eventdrops-demo')
            .data([repositoriesData])
            .call(chart);
    </script>
{% endblock %}